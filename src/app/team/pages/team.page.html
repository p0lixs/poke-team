<div class="layout">
    <section>
        <app-search-box (valueChange)="facade.query.set($event)"></app-search-box>
        @if(facade.results().length > 0){
        <app-results-list [results]="facade.results()" (add)="facade.addToTeam($event)" />
        }
        @if(facade.loading()){
        <div class="muted" style="margin:.75rem 0">Searching...</div>
        }
        @if(facade.error()){
        <div style="color:red">{{ facade.error() }}</div>
        }
        @if(!facade.loading() && facade.results().length === 0){
        <p class="muted">
            Type at least 2 letters to search.
        </p>
        }
    </section>
    <aside>
        <app-team-panel [team]="facade.team()" [teamName]="facade.teamName()" [savedTeams]="facade.savedTeams()"
            [selectedTeamId]="facade.selectedTeamId()" [items]="facade.itemOptions()" [natures]="facade.natureOptions()"
            (teamNameChange)="facade.setTeamName($event)" (selectTeam)="facade.selectTeam($event)"
            (createTeam)="facade.createCurrentTeam()" (remove)="facade.removeFromTeam($event)"
            (clear)="facade.clearTeam()" (moveChange)="facade.changePokemonMove($event)"
            (abilityChange)="facade.changePokemonAbility($event)" (itemChange)="facade.changePokemonItem($event)"
            (natureChange)="facade.changePokemonNature($event)" (levelChange)="facade.changePokemonLevel($event)"
            (statChange)="facade.changePokemonStats($event)" (teraTypeChange)="facade.changePokemonTeraType($event)"
            (openImport)="openImportDialog()" (openExport)="openExportDialog()"
            (openWeaknesses)="openWeaknessDialog()" />

        @if (showImportModal) {
        <div class="modal-backdrop" (click)="closeImportDialog()"></div>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="import-title">
            <div class="modal__header">
                <h3 class="modal__title" id="import-title">Import team</h3>
                <button type="button" class="modal__close" (click)="closeImportDialog()"
                    [disabled]="isImporting">×</button>
            </div>
            <div class="modal__body">
                <label class="modal__label" for="team-import-text">Team text</label>
                <textarea id="team-import-text" class="modal__textarea" [(ngModel)]="importText"
                    placeholder="Paste your team here" [disabled]="isImporting"></textarea>
                @if (importError) {
                <p class="modal__error">{{ importError }}</p>
                }
            </div>
            <div class="modal__footer">
                <button type="button" class="modal__button" (click)="closeImportDialog()"
                    [disabled]="isImporting">Cancel</button>
                <button type="button" class="modal__button modal__button--primary" (click)="confirmImport()"
                    [disabled]="isImporting">Import</button>
            </div>
        </div>
        }

        @if (showExportModal) {
        <div class="modal-backdrop" (click)="closeExportDialog()"></div>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="export-title">
            <div class="modal__header">
                <h3 class="modal__title" id="export-title">Export team</h3>
                <button type="button" class="modal__close" (click)="closeExportDialog()">×</button>
            </div>
            <div class="modal__body">
                <label class="modal__label" for="team-export-text">Team text</label>
                <textarea id="team-export-text" class="modal__textarea" [value]="exportText" readonly></textarea>
                <div class="modal__note">
                    @if (copyStatus === 'copied') {
                    <span class="modal__feedback modal__feedback--success">Copied to clipboard</span>
                    } @else if (copyStatus === 'error') {
                    <span class="modal__feedback modal__feedback--error">Copy failed. Select the text manually.</span>
                    } @else {
                    <span class="modal__feedback">Use the copy button or select the text manually.</span>
                    }
                </div>
            </div>
            <div class="modal__footer">
                <button type="button" class="modal__button" (click)="closeExportDialog()">Close</button>
                <button type="button" class="modal__button modal__button--primary" (click)="copyExportText()"
                    [disabled]="!exportText">Copy</button>
            </div>
        </div>
        }

        @if (showWeaknessModal) {
        <div class="modal-backdrop" (click)="closeWeaknessDialog()"></div>
        <div class="modal modal--wide" role="dialog" aria-modal="true" aria-labelledby="weakness-title">
            <div class="modal__header">
                <h3 class="modal__title" id="weakness-title">Team weaknesses</h3>
                <button type="button" class="modal__close" (click)="closeWeaknessDialog()">×</button>
            </div>
            <div class="modal__body">
                <p class="modal__note">Multipliers use each Pokémon's base typing by default. Toggle a Tera type to
                    recalculate weaknesses using that typing.</p>
                <div class="weakness-table-wrapper" role="table" aria-label="Type weaknesses">
                    <div class="weakness-table" role="rowgroup">
                        <div class="weakness-row weakness-row--header" role="row">
                            <div class="weakness-cell weakness-cell__pokemon" role="columnheader">Pokémon</div>
                            @for (type of typeColumns; track type.name) {
                            <div class="weakness-cell weakness-cell__type" role="columnheader">
                                <app-type-icon [typeDetails]="[type]" [size]="70"></app-type-icon>
                            </div>
                            }
                        </div>
                        @for (row of weaknessTable().rows; track row.pokemon.id) {
                        <div class="weakness-row" role="row">
                            <div class="weakness-cell weakness-cell__pokemon" role="rowheader">
                                <div class="pokemon-name">{{ row.pokemon.name }}</div>
                                <div class="pokemon-types">
                                    <app-type-icon [typeDetails]="row.pokemon.typeDetails" [size]="70"></app-type-icon>
                                    @if (row.teraType) {
                                    <button type="button" class="tera-pill" [class.is-active]="row.useTera"
                                        [attr.aria-pressed]="row.useTera"
                                        (click)="toggleTeraType(row.pokemon.id.toString())">
                                        <span aria-hidden="true">Tera: {{ row.teraType }}</span>
                                        <span class="sr-only">Toggle Tera type for {{ row.pokemon.name }}</span>
                                        <span class="tera-pill__state">{{ row.useTera ? 'On' : 'Off' }}</span>
                                    </button>
                                    }
                                </div>
                            </div>
                            @for (cell of row.cells; track cell.type) {
                            <div class="weakness-cell" role="cell" [attr.aria-label]="cell.type + ' damage'"
                                [class.is-immune]="cell.multiplier === 0"
                                [class.is-resist]="cell.multiplier > 0 && cell.multiplier < 1"
                                [class.is-neutral]="cell.multiplier === 1" [class.is-weak]="cell.multiplier > 1">
                                {{ cell.label }}
                            </div>
                            }
                        </div>
                        }
                        <div class="weakness-row weakness-row--summary" role="row">
                            <div class="weakness-cell weakness-cell__pokemon" role="rowheader">Weak x2/x4 count</div>
                            @for (summary of weaknessTable().summary; track summary.type) {
                            <div class="weakness-cell weakness-cell__summary" role="cell">{{ summary.count }}</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button type="button" class="modal__button" (click)="closeWeaknessDialog()">Close</button>
            </div>
        </div>
        }
    </aside>
</div>