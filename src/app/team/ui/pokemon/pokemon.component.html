<article class="pokemon-card">
  <header class="head">
    <img class="sprite" [src]="pokemon.sprite || 'assets/placeholder-poke.png'" [alt]="pokemon.name" loading="lazy"
      referrerpolicy="no-referrer" />
    <div class="title">
      <h3 class="name">{{ pokemon.name }}</h3>
      <!-- pokemon.component.html (replace the type section) -->
      @if (pokemon['typeDetails'].length) {
      <app-type-icon [typeDetails]="pokemon.typeDetails" [size]="100"></app-type-icon>
      } @else if (pokemon.types.length) {
      <!-- Fallback in case typeDetails are not available yet -->
      <ul class="types">
        @for (name of pokemon.types; track $index) {
        <li class="type-pill">{{ name }}</li>
        }
      </ul>
      }
    </div>
  </header>

  @if (pokemon.stats.length) {
  <section class="stats">
    <h4 class="stats__title">Statistics</h4>
    <ul class="stats__list">
      @for (stat of pokemon.stats; track stat.name) {
      <li class="stats__item">
        <span class="stats__label">{{ stat.label }}</span>
        <div class="stats__bar">
          <div class="stats__bar-fill" [style.width.%]="getStatPercentage(stat)"
            [style.background]="getStatGradient(stat)"></div>
        </div>
        <span class="stats__value">{{ stat.value }}</span>
      </li>
      }
    </ul>
  </section>
  }

  @if (pokemon.moves.length) {
  <section class="moves">
    <div class="moves__header">
      <h4 class="moves__title">Moves</h4>
    </div>
    <ul class="moves__selected-list">
      @for (slot of moveSlots; track slot) {
      @let selected = pokemon.selectedMoves[slot];
      <li class="moves__selected-item">
        <button type="button" class="moves__selected-button" (click)="openMoveModal()" [class.is-empty]="!selected">
          @if (selected) {
          @let icon = getMoveIcon(selected);
          @let typeName = formatTypeName(selected.type?.name ?? '');
          <span class="moves__selected-chip">
            <span class="moves__selected-name">{{ selected.name }}</span>
            @if (icon) {
            <img class="moves__selected-icon" [src]="icon" [alt]="selected.type?.name ?? 'type'" />
            } @else {
            <span class="moves__selected-badge-label">
              {{ typeName ? typeName.slice(0, 3) : '—' }}
            </span>
            }

          </span>
          } @else {
          <span class="moves__placeholder">Select move {{ slot + 1 }}</span>
          }
        </button>
      </li>
      }
    </ul>
  </section>
  }

  <footer class="actions">
    @if (showRemove) {
    <button type="button" class="btn-remove" (click)="onRemove()">Remove</button>
    }
  </footer>
</article>

@if (isMoveModalOpen) {
<div class="move-modal">
  <div class="move-modal__backdrop" (click)="closeMoveModal()"></div>
  <div class="move-modal__dialog" role="dialog" aria-modal="true" aria-label="Move selector">
    <header class="move-modal__header">
      <h3 class="move-modal__title">Choose moves</h3>
      <button type="button" class="move-modal__close" (click)="closeMoveModal()" aria-label="Close">×</button>
    </header>
    <div class="move-modal__body">
      <label class="move-modal__search">
        <span class="move-modal__search-label">Search</span>
        <input type="search" class="move-modal__search-input" [(ngModel)]="moveSearchTerm"
          (ngModelChange)="onSearchTermChange()" placeholder="Search move" />
      </label>

      <div class="move-modal__selected">
        <div class="move-modal__selected-header">
          <h4 class="move-modal__selected-title">Selected moves</h4>
          <span class="move-modal__selected-count">{{ pendingSelectionCount }}/4</span>
        </div>
        <ul class="move-modal__selected-list">
          @for (slot of moveSlots; track slot) {
          @let move = pendingSelection[slot];
          <li class="move-modal__selected-item">
            @if (move) {
            <button type="button" class="move-modal__selected-chip" (click)="removeSelectedMove(slot)">
              @let icon = getMoveIcon(move);
              @if (icon) {
              <img class="move-modal__selected-icon" [src]="icon" [alt]="move.type?.name ?? 'type'" />
              } @else if (move.type?.name) {
              <span class="move-modal__selected-type">{{ formatTypeName(move.type?.name ?? '') }}</span>
              }
              <span class="move-modal__selected-name">{{ move.name }}</span>
              <span class="move-modal__selected-remove" aria-hidden="true">×</span>
            </button>
            } @else {
            <span class="move-modal__selected-placeholder">Empty slot</span>
            }
          </li>
          }
        </ul>
      </div>

      <div class="move-modal__table-wrapper">
        <table class="move-modal__table">
          <thead>
            <tr>
              <th scope="col">Move</th>
              <th scope="col">Type</th>
              <th scope="col">Power</th>
              <th scope="col">Accuracy</th>
              <th scope="col">Category</th>
              <th scope="col" class="move-modal__effect-column">Effect</th>
            </tr>
          </thead>
          <tbody>
            @if (!filteredMoveRows.length) {
            <tr class="move-modal__empty">
              <td colspan="6">No moves match the search.</td>
            </tr>
            } @else {
            @for (row of filteredMoveRows; track row.url) {
            <tr class="move-modal__row" (click)="toggleMoveSelection(row)" [class.is-selected]="isMoveSelected(row.url)"
              [class.is-disabled]="pendingSelectionCount >= moveSlots.length && !isMoveSelected(row.url)">
              <td data-label="Move">{{ row.label }}</td>
              <td data-label="Type">
                @if (row.typeIcon) {
                <img class="move-modal__type-icon" [src]="row.typeIcon" [alt]="row.type?.name ?? 'type'" />
                } @else if (row.type?.name) {
                <span class="move-modal__type-pill">{{ formatTypeName(row.type?.name ?? '') }}</span>
                } @else {
                <span class="move-modal__type-pill">—</span>
                }
              </td>
              <td data-label="Power">{{ row.power !== null ? row.power : '—' }}</td>
              <td data-label="Accuracy">{{ row.accuracy !== null ? row.accuracy + '%' : '—' }}</td>
              <td data-label="Category">{{ formatCategory(row.damageClass) }}</td>
              <td data-label="Effect" class="move-modal__effect-cell">
                @if (row.effect) {
                <span class="move-modal__effect" [title]="row.effect">{{ row.effect }}</span>
                } @else if (row.loading) {
                <span class="move-modal__effect move-modal__effect--loading">Loading…</span>
                } @else {
                <span class="move-modal__effect">—</span>
                }
              </td>
            </tr>
            }
            }
          </tbody>
        </table>
      </div>
    </div>
    <footer class="move-modal__footer">
      <button type="button" class="move-modal__cancel" (click)="closeMoveModal()">Cancel</button>
      <button type="button" class="move-modal__save" (click)="saveMoveSelection()">Save</button>
    </footer>
  </div>
</div>
}