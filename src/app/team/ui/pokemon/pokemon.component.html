<article class="pokemon-card">
  <header class="head">
    <img class="sprite" [src]="pokemon.sprite || 'assets/placeholder-poke.png'" [alt]="pokemon.name" loading="lazy"
      referrerpolicy="no-referrer" />
    <div class="title">
      <h3 class="name">{{ pokemon.name }}</h3>
      <!-- pokemon.component.html (sustituye la parte de tipos) -->
      @if (pokemon['typeDetails'].length) {
      <app-type-icon [typeDetails]="pokemon.typeDetails" [size]="100"></app-type-icon>
      } @else if (pokemon.types.length) {
      <!-- Fallback por si aún no tienes typeDetails -->
      <ul class="types">
        @for (name of pokemon.types; track $index) {
        <li class="type-pill">{{ name }}</li>
        }
      </ul>
      }
    </div>
  </header>

  @if (pokemon.stats.length) {
  <section class="stats">
    <h4 class="stats__title">Estadísticas</h4>
    <ul class="stats__list">
      @for (stat of pokemon.stats; track stat.name) {
      <li class="stats__item">
        <span class="stats__label">{{ stat.label }}</span>
        <div class="stats__bar">
          <div class="stats__bar-fill" [style.width.%]="getStatPercentage(stat)"
            [style.background]="getStatGradient(stat)"></div>
        </div>
        <span class="stats__value">{{ stat.value }}</span>
      </li>
      }
    </ul>
  </section>
  }

  @if (pokemon.moves.length) {
  <section class="moves">
    <div class="moves__header">
      <h4 class="moves__title">Movimientos</h4>
      <button type="button" class="moves__manage" (click)="openMoveModal()">Gestionar</button>
    </div>
    <ul class="moves__selected-list">
      @for (slot of moveSlots; track slot) {
      @let selected = pokemon.selectedMoves[slot];
      <li class="moves__selected-item">
        <button
          type="button"
          class="moves__selected-button"
          (click)="openMoveModal()"
          [class.is-empty]="!selected"
        >
          @if (selected) {
          @let icon = getMoveIcon(selected);
          @let typeName = formatTypeName(selected.type?.name ?? '');
          <span class="moves__selected-chip">
            <span class="moves__selected-badge" [class.has-icon]="!!icon">
              @if (icon) {
              <img class="moves__selected-icon" [src]="icon" [alt]="selected.type?.name ?? 'tipo'" />
              } @else {
              <span class="moves__selected-badge-label">
                {{ typeName ? typeName.slice(0, 3) : '—' }}
              </span>
              }
            </span>
            <span class="moves__selected-info">
              <span class="moves__selected-name">{{ selected.name }}</span>
              @if (typeName) {
              <span class="moves__selected-type">{{ typeName }}</span>
              }
            </span>
          </span>
          } @else {
          <span class="moves__placeholder">Seleccionar movimiento {{ slot + 1 }}</span>
          }
        </button>
      </li>
      }
      }
    </ul>
    } @else {
    <p class="moves__empty">No hay movimientos seleccionados. Pulsa en «Editar movimientos» para elegir hasta
      cuatro.</p>
    }
  </section>
  }

  @if (isMoveModalOpen) {
  <div class="moves-modal" role="dialog" aria-modal="true" [attr.aria-labelledby]="'moves-modal-title-' + pokemon.id">
    <div class="moves-modal__backdrop" (click)="closeMovesModal()"></div>
    <div class="moves-modal__dialog" role="document">
      <header class="moves-modal__header">
        <h5 class="moves-modal__title" [id]="'moves-modal-title-' + pokemon.id">Selecciona movimientos</h5>
        <button type="button" class="moves-modal__close" (click)="closeMovesModal()" aria-label="Cerrar">×</button>
      </header>

      <div class="moves-modal__content">
        <div class="moves-modal__search">
          <label class="moves-modal__search-label" [attr.for]="'move-search-' + pokemon.id">Buscar movimiento</label>
          <input class="moves-modal__search-input" type="text" [id]="'move-search-' + pokemon.id"
            [ngModel]="moveSearchTerm" (ngModelChange)="onSearchTermChange($event)"
            placeholder="Empieza a escribir el nombre" />
        </div>

        <div class="moves-modal__selected">
          <h6 class="moves-modal__selected-title">Seleccionados ({{ pendingSelectedMovesCount }}/4)</h6>
          <ul class="moves-modal__selected-list">
            @for (slot of moveSlots; track slot) {
            @let pending = pendingSelectedMoves[slot];
            <li class="moves-modal__selected-item" [class.is-filled]="!!pending">
              <div class="moves-modal__slot">
                <span class="moves-modal__slot-label">Movimiento {{ slot + 1 }}</span>
                @if (pending) {
                <div class="moves-modal__slot-move">
                  @if (getMoveIcon(pending); as icon) {
                  <img class="moves-modal__slot-icon" [src]="icon" [alt]="pending.type?.name ?? 'tipo'" />
                  } @else if (pending.type?.name) {
                  <span class="moves-modal__slot-type">{{ formatTypeName(pending.type?.name ?? '') }}</span>
                  }
                  <span class="moves-modal__slot-name">{{ pending.name }}</span>
                </div>
                } @else {
                <span class="moves-modal__slot-empty">Vacío</span>
                }
              </div>
              @if (pending) {
              <button type="button" class="moves-modal__remove"
                (click)="removePendingMove(slot); $event.stopPropagation()">Quitar</button>
              }
            </li>
            }
          </ul>
        </div>

        <div class="moves-modal__table-wrapper">
          <table class="moves-modal__table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Poder</th>
                <th>Precisión</th>
                <th>Categoría</th>
                <th>Efecto</th>
              </tr>
            </thead>
            <tbody>
              @for (move of filteredMoves; track move.url) {
              <tr (click)="onMoveRowClick(move)" [class.is-selected]="isMoveSelected(move)"
                [class.is-disabled]="!isMoveSelected(move) && !canSelectMoreMoves()">
                <td class="moves-modal__cell-name">{{ move.label }}</td>
                <td class="moves-modal__cell-type">
                  @if (getMoveIcon(move); as icon) {
                  <img class="moves-modal__table-icon" [src]="icon" [alt]="move.type?.name ?? 'tipo'" />
                  } @else if (move.type?.name) {
                  <span class="moves-modal__table-type">{{ formatTypeName(move.type?.name ?? '') }}</span>
                  } @else {
                  <span class="moves-modal__table-type moves-modal__table-type--unknown">—</span>
                  }
                </td>
                <td class="moves-modal__cell-number">{{ move.power ?? '—' }}</td>
                <td class="moves-modal__cell-number">{{ move.accuracy !== null ? move.accuracy + '%' : '—' }}</td>
                <td>{{ move.category ?? '—' }}</td>
                <td class="moves-modal__effect">{{ move.effect ?? '—' }}</td>
              </tr>
              }
              @if (!filteredMoves.length) {
              <tr>
                <td class="moves-modal__empty" colspan="6">No se han encontrado movimientos que coincidan.</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <footer class="moves-modal__footer">
        <button type="button" class="moves-modal__button moves-modal__button--ghost" (click)="closeMovesModal()">
          Cancelar
        </button>
        <button type="button" class="moves-modal__button" (click)="confirmMovesSelection()">
          Guardar movimientos
        </button>
      </footer>
    </div>
  </div>
  }

  <footer class="actions">
    @if (showRemove) {
    <button type="button" class="btn-remove" (click)="onRemove()">Quitar</button>
    }
  </footer>
</article>

@if (isMoveModalOpen) {
<div class="move-modal">
  <div class="move-modal__backdrop" (click)="closeMoveModal()"></div>
  <div class="move-modal__dialog" role="dialog" aria-modal="true" aria-label="Selector de movimientos">
    <header class="move-modal__header">
      <h3 class="move-modal__title">Selecciona los movimientos</h3>
      <button type="button" class="move-modal__close" (click)="closeMoveModal()" aria-label="Cerrar">×</button>
    </header>
    <div class="move-modal__body">
      <label class="move-modal__search">
        <span class="move-modal__search-label">Buscar</span>
        <input type="search" class="move-modal__search-input" [(ngModel)]="moveSearchTerm"
          (ngModelChange)="onSearchTermChange()" placeholder="Buscar movimiento" />
      </label>

      <div class="move-modal__selected">
        <div class="move-modal__selected-header">
          <h4 class="move-modal__selected-title">Movimientos seleccionados</h4>
          <span class="move-modal__selected-count">{{ pendingSelectionCount }}/4</span>
        </div>
        <ul class="move-modal__selected-list">
          @for (slot of moveSlots; track slot) {
          @let move = pendingSelection[slot];
          <li class="move-modal__selected-item">
            @if (move) {
            <button type="button" class="move-modal__selected-chip" (click)="removeSelectedMove(slot)">
              @let icon = getMoveIcon(move);
              @if (icon) {
              <img class="move-modal__selected-icon" [src]="icon" [alt]="move.type?.name ?? 'tipo'" />
              } @else if (move.type?.name) {
              <span class="move-modal__selected-type">{{ formatTypeName(move.type?.name ?? '') }}</span>
              }
              <span class="move-modal__selected-name">{{ move.name }}</span>
              <span class="move-modal__selected-remove" aria-hidden="true">×</span>
            </button>
            } @else {
            <span class="move-modal__selected-placeholder">Hueco libre</span>
            }
          </li>
          }
        </ul>
      </div>

      <div class="move-modal__table-wrapper">
        <table class="move-modal__table">
          <thead>
            <tr>
              <th scope="col">Movimiento</th>
              <th scope="col">Tipo</th>
              <th scope="col">Poder</th>
              <th scope="col">Precisión</th>
              <th scope="col">Categoría</th>
              <th scope="col" class="move-modal__effect-column">Efecto</th>
            </tr>
          </thead>
          <tbody>
            @if (!filteredMoveRows.length) {
            <tr class="move-modal__empty">
              <td colspan="6">No hay movimientos que coincidan con la búsqueda.</td>
            </tr>
            } @else {
            @for (row of filteredMoveRows; track row.url) {
            <tr class="move-modal__row" (click)="toggleMoveSelection(row)"
              [class.is-selected]="isMoveSelected(row.url)"
              [class.is-disabled]="pendingSelectionCount >= moveSlots.length && !isMoveSelected(row.url)">
              <td data-label="Movimiento">{{ row.label }}</td>
              <td data-label="Tipo">
                @if (row.typeIcon) {
                <img class="move-modal__type-icon" [src]="row.typeIcon" [alt]="row.type?.name ?? 'tipo'" />
                } @else if (row.type?.name) {
                <span class="move-modal__type-pill">{{ formatTypeName(row.type?.name ?? '') }}</span>
                } @else {
                <span class="move-modal__type-pill">—</span>
                }
              </td>
              <td data-label="Poder">{{ row.power !== null ? row.power : '—' }}</td>
              <td data-label="Precisión">{{ row.accuracy !== null ? row.accuracy + '%' : '—' }}</td>
              <td data-label="Categoría">{{ formatCategory(row.damageClass) }}</td>
              <td data-label="Efecto" class="move-modal__effect-cell">
                @if (row.effect) {
                <span class="move-modal__effect" [title]="row.effect">{{ row.effect }}</span>
                } @else if (row.loading) {
                <span class="move-modal__effect move-modal__effect--loading">Cargando…</span>
                } @else {
                <span class="move-modal__effect">—</span>
                }
              </td>
            </tr>
            }
            }
          </tbody>
        </table>
      </div>
    </div>
    <footer class="move-modal__footer">
      <button type="button" class="move-modal__cancel" (click)="closeMoveModal()">Cancelar</button>
      <button type="button" class="move-modal__save" (click)="saveMoveSelection()">Guardar</button>
    </footer>
  </div>
</div>
}
